<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>CIPA-PAUV 2026/2027</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --unimed-verde: #006837; --unimed-claro: #e6f5e6; --danger: #c62828; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        body { background-color: var(--unimed-claro); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        .header { background: #fff; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header img { max-width: 180px; }

        section { display: none; flex: 1; align-items: center; justify-content: center; padding: 20px; }
        .painel-central { background: #fff; padding: 40px; border-radius: 25px; border: 2px solid var(--unimed-verde); box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }

        h1 { color: var(--unimed-verde); font-size: 26px; margin-bottom: 20px; }
        input { font-size: 22px; padding: 15px; border-radius: 12px; border: 2px solid #ddd; width: 100%; text-align: center; margin-bottom: 20px; outline: none; }
        
        button { border: none; border-radius: 12px; cursor: pointer; font-weight: bold; padding: 20px; font-size: 18px; transition: 0.3s; width: 100%; }
        .btn-confirm { background: var(--unimed-verde); color: #fff; }
        .btn-cancel { background: var(--danger); color: #fff; margin-top: 10px; }

        /* GRID VOTAÇÃO */
        .grid-candidatos { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; width: 100%; max-width: 900px; overflow-y: auto; padding: 10px; }
        .card { background: #fff; border-radius: 15px; padding: 10px; cursor: pointer; border: 4px solid transparent; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .card img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--unimed-verde); margin-bottom: 8px; }

        /* REVISÃO */
        .revisao-img { width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--unimed-verde); object-fit: cover; margin-bottom: 15px; }
        
        /* ANIMAÇÃO DE AGUARDE */
        .spinner { border: 4px solid rgba(0, 104, 55, 0.1); border-left-color: var(--unimed-verde); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body onload="iniciarSistema()">

    <audio id="somUrna" src="audio/sucesso.mp3"></audio>
    <div class="header no-print"><img src="unimed_vitoria_logo.png"></div>

    <section id="tela-aguarde" style="display: flex;">
        <div class="painel-central">
            <h1>Bem-vindo à CIPA</h1>
            <div class="spinner"></div>
            <p style="color: #666; font-size: 18px;">Por favor, identifique-se com o fiscal para liberar sua votação.</p>
        </div>
    </section>

    <section id="tela-entrada-confirm">
        <div class="painel-central">
            <h1 style="font-size: 20px;">Votação Liberada!</h1>
            <div style="background: var(--unimed-claro); padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                <p style="font-size: 16px; color: #333;">Olá,</p>
                <p id="nome-eleitor-entrada" style="font-size: 22px; font-weight: bold; color: var(--unimed-verde);"></p>
            </div>
            <button class="btn-confirm" onclick="irParaVotacao()">CONFIRMAR E VOTAR</button>
        </div>
    </section>

    <section id="tela-fiscal">
        <div class="painel-central">
            <h1 style="color: #005a8d;">Painel do Fiscal</h1>
            <input type="text" id="mat-fiscal" placeholder="Matrícula" oninput="buscarColaborador()">
            <div id="display-colaborador" style="margin-bottom:20px; font-weight:bold; color: var(--unimed-verde); font-size: 18px;"></div>
            <button id="btn-liberar" class="btn-confirm" style="display:none;" onclick="liberarNoSistema()">LIBERAR NO TABLET</button>
            <button class="btn-cancel" onclick="window.location.href='index.html'">SAIR</button>
        </div>
    </section>

    <section id="tela-votacao" style="flex-direction: column;">
        <h1 id="msg-eleitor-topo">Escolha seu Candidato</h1>
        <div id="grid-fotos" class="grid-candidatos"></div>
        <div style="max-width: 400px; width: 100%; display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn-esp" style="background:#ddd; flex:1;" onclick="revisarVoto('branco')">BRANCO</button>
            <button class="btn-esp" style="background:#555; color:#fff; flex:1;" onclick="revisarVoto('nulo')">NULO</button>
        </div>
    </section>

    <section id="tela-revisao">
        <div class="painel-central">
            <h1 style="color: var(--danger)">Confirme seu Voto</h1>
            <div id="caixa-revisao"></div>
            <button class="btn-confirm" onclick="registrarVoto()">CONFIRMAR FINAL</button>
            <button class="btn-cancel" onclick="mostrar('tela-votacao')">CORRIGIR</button>
        </div>
    </section>

    <section id="tela-admin-login" style="background: var(--unimed-verde); display: none;">
        <div class="painel-central">
            <div class="logo-container"><img src="unimed_vitoria_logo.png" style="width:150px; margin-bottom:20px;"></div>
            <h1>Acesso Admin</h1>
            <input type="password" id="senha-admin" placeholder="Senha Administrativa">
            <button class="btn-confirm" onclick="validarAdmin()">VER APURAÇÃO</button>
        </div>
    </section>

    <section id="tela-admin-res" style="flex-direction: column;">
        <div style="width: 100%; max-width: 1000px; background:white; padding: 20px; border-radius: 20px;">
            <h1>Apuração Final</h1>
            <div id="grid-resultados" class="grid-candidatos"></div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px;">
                <div style="background:#eee; padding:10px; border-radius:10px;">VOTOS <b id="res-val">0</b></div>
                <div style="background:#eee; padding:10px; border-radius:10px;">BRANCO <b id="res-bra">0</b></div>
                <div style="background:#eee; padding:10px; border-radius:10px;">NULO <b id="res-nul">0</b></div>
                <div style="background:#eee; padding:10px; border-radius:10px;">TOTAL <b id="res-total">0</b></div>
            </div>
            <div class="no-print" style="margin-top:20px; display:flex; gap:10px;">
                <button onclick="exportarExcel()" style="background:#005a8d; color:white;">EXCEL</button>
                <button class="btn-confirm" onclick="window.print()">IMPRIMIR</button>
                <button class="btn-cancel" onclick="resetarSistema()">ZERAR</button>
            </div>
        </div>
    </section>

    <div id="modal-sucesso" style="position:fixed; inset:0; background:rgba(255,255,255,0.95); display:none; align-items:center; justify-content:center; z-index:9999;">
        <div class="painel-central">
            <div style="font-size: 80px; color: var(--unimed-verde);">✓</div>
            <h1>VOTO GRAVADO!</h1>
            <p>Obrigado por participar.</p>
        </div>
    </div>

    <script>
        let colaboradores = {};
        let matriculaAtiva = "";
        let votoEscolhido = null;

        const fotos = [
            "fotos/01-Wanilton_Laurenco.jpg", "fotos/02-maria_oliveira.jpg",
            "fotos/03-ana_pereira.jpg", "fotos/04-carlos_souza.jpg",
            "fotos/05-lucas_ferreira.jpg", "fotos/06-ana_paula.jpg",
            "fotos/07-bruna_martins.jpg", "fotos/08-ricardo_lima.jpg",
            "fotos/09-juliana_rodrigues.jpg"
        ];
        const nomesCandidatos = fotos.map(f => {
            const arq = f.split('/').pop().split('.')[0];
            return arq.slice(0, 2) + " - " + arq.slice(3).replace(/_/g, ' ');
        });

        async function iniciarSistema() {
            await carregarCSV();
            const params = new URLSearchParams(window.location.search);
            
            if (params.has('admin')) {
                mostrar('tela-admin-login');
            } else if (params.has('fiscal')) {
                mostrar('tela-fiscal');
            } else {
                // TELA DO ELEITOR: Verifica liberação a cada 2 segundos
                checkLiberacaoContinuamente();
            }
        }

        function checkLiberacaoContinuamente() {
            setInterval(() => {
                const lib = localStorage.getItem("liberado");
                if (lib && matriculaAtiva === "") {
                    matriculaAtiva = lib;
                    document.getElementById('nome-eleitor-entrada').textContent = colaboradores[lib] || lib;
                    mostrar('tela-entrada-confirm');
                }
            }, 1000);
        }

        async function carregarCSV() {
            try {
                const res = await fetch('listacolaboradores.csv');
                const text = await res.text();
                text.split('\n').forEach(linha => {
                    const col = linha.split(';');
                    if (col.length >= 2) colaboradores[col[0].trim()] = col[1].trim();
                });
            } catch (e) { console.log("Erro CSV"); }
            renderizarCards();
        }

        // --- FISCAL ---
        function buscarColaborador() {
            const m = document.getElementById('mat-fiscal').value.trim();
            const display = document.getElementById('display-colaborador');
            const btn = document.getElementById('btn-liberar');
            const jaVotou = (JSON.parse(localStorage.getItem("votantes")) || []).includes(m);

            if (jaVotou) { display.textContent = "❌ JÁ VOTOU!"; btn.style.display="none"; }
            else if (colaboradores[m]) { display.textContent = "✅ " + colaboradores[m]; btn.style.display="block"; }
            else { display.textContent = ""; btn.style.display="none"; }
        }

        function liberarNoSistema() {
            const m = document.getElementById('mat-fiscal').value.trim();
            localStorage.setItem("liberado", m);
            alert("Liberado! O tablet do eleitor vai atualizar sozinho.");
            document.getElementById('mat-fiscal').value = "";
            buscarColaborador();
        }

        // --- ELEITOR ---
        function irParaVotacao() {
            document.getElementById('msg-eleitor-topo').textContent = "Candidatos - " + colaboradores[matriculaAtiva];
            mostrar('tela-votacao');
        }

        function renderizarCards() {
            const grid = document.getElementById('grid-fotos');
            grid.innerHTML = "";
            fotos.forEach((f, i) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `<img src="${f}"><div><small>${nomesCandidatos[i]}</small></div>`;
                div.onclick = () => revisarVoto(i);
                grid.appendChild(div);
            });
        }

        function revisarVoto(idx) {
            votoEscolhido = idx;
            const caixa = document.getElementById('caixa-revisao');
            if (idx === 'branco') { votoEscolhido = 9; caixa.innerHTML = `<h1>VOTO BRANCO</h1>`; }
            else if (idx === 'nulo') { votoEscolhido = 10; caixa.innerHTML = `<h1 style="color:red">VOTO NULO</h1>`; }
            else { caixa.innerHTML = `<img src="${fotos[idx]}" class="revisao-img"><h1>${nomesCandidatos[idx]}</h1>`; }
            mostrar('tela-revisao');
        }

        function registrarVoto() {
            let votos = JSON.parse(localStorage.getItem("votos")) || Array(11).fill(0);
            let votantes = JSON.parse(localStorage.getItem("votantes")) || [];
            votos[votoEscolhido]++;
            votantes.push(matriculaAtiva);
            localStorage.setItem("votos", JSON.stringify(votos));
            localStorage.setItem("votantes", JSON.stringify(votantes));
            localStorage.removeItem("liberado"); // Bloqueia o tablet de novo

            document.getElementById('somUrna').play();
            document.getElementById('modal-sucesso').style.display = 'flex';
            setTimeout(() => { location.reload(); }, 3000);
        }

        // --- ADMIN ---
        function validarAdmin() {
            if (document.getElementById('senha-admin').value === "admin123") {
                mostrar('tela-admin-res');
                carregarResultados();
            } else { alert("Senha incorreta"); }
        }

        function carregarResultados() {
            const grid = document.getElementById('grid-resultados');
            grid.innerHTML = "";
            let v = JSON.parse(localStorage.getItem("votos")) || Array(11).fill(0);
            fotos.forEach((f, i) => {
                grid.innerHTML += `<div class="card"><img src="${f}"><b>${nomesCandidatos[i]}</b><br><b style="color:red;">${v[i]}</b></div>`;
            });
            document.getElementById('res-val').textContent = v.slice(0, 9).reduce((a, b) => a + b, 0);
            document.getElementById('res-bra').textContent = v[9];
            document.getElementById('res-nul').textContent = v[10];
            document.getElementById('res-total').textContent = (JSON.parse(localStorage.getItem("votantes")) || []).length;
        }

        function exportarExcel() {
            let csv = "\ufeffMatrícula;Nome\n";
            let vts = JSON.parse(localStorage.getItem("votantes")) || [];
            vts.forEach(m => csv += `${m};${colaboradores[m] || 'N/A'}\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "Relatorio_CIPA.csv";
            a.click();
        }

        function resetarSistema() {
            if (prompt("Senha para ZERAR:") === "admin1234") { localStorage.clear(); location.reload(); }
        }

        function mostrar(id) {
            document.querySelectorAll('section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'flex';
        }
    </script>
</body>
</html>