<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Vota√ß√£o CIPA-PAUV 2026/2027 - Unimed Vit√≥ria</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Manuten√ß√£o do estilo anterior para consist√™ncia visual */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        html, body { height: 100%; background: #e6f5e6; overflow: hidden; }
        body { display: flex; flex-direction: column; }

        .logo-container { width: 100%; display: flex; justify-content: center; margin-bottom: 25px; }
        .logo-container img { max-width: 320px; height: auto; }

        button { border: none; border-radius: 15px; cursor: pointer; font-weight: bold; transition: .3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        button.primary { background: #006837; color: #fff; padding: 20px 40px; font-size: 20px; }
        button.secondary { background: #c62828; color: #fff; padding: 20px 40px; font-size: 20px; }
        button.info { background: #005a8d; color: #fff; padding: 18px 36px; font-size: 18px; }
        button:hover { opacity: 0.9; transform: scale(1.05); }

        section { display: none; flex: 1; width: 100%; overflow-y: auto; padding: 20px; text-align: center; flex-direction: column; align-items: center; }
        #entrada, #login, #confirmaLogin { justify-content: center; height: 100vh; }

        h1 { color: #006837; font-size: 45px; margin-bottom: 15px; }
        h2 { color: #004d26; font-size: 28px; margin-bottom: 40px; font-weight: normal; }

        input { font-size: 24px; padding: 18px; border-radius: 12px; border: 2px solid #006837; text-align: center; width: 350px; margin-bottom: 25px; outline: none; }

        #votacao { justify-content: flex-start; padding-top: 30px; overflow-y: auto; }
        #painel { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; width: 100%; max-width: 1100px; margin: 0 auto 30px auto; }
        .candidato { background: #fff; border-radius: 15px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; display: flex; flex-direction: column; align-items: center; border: 4px solid transparent; transition: 0.2s; }
        .candidato.selecionado { border-color: #006837; background: #f0fff0; }
        .candidato img { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 3px solid #006837; margin-bottom: 10px; }

        .grafico { max-width: 850px; width: 100%; margin: 20px auto; text-align: left; }
        .barra-fundo { background: #cde8cd; border-radius: 20px; overflow: hidden; height: 40px; }
        .barra-preenchimento { height: 100%; background: #006837; color: #fff; text-align: right; padding-right: 15px; line-height: 40px; width: 0; transition: 1.2s; font-weight: bold; }

        .botoes-centro { display: flex; justify-content: center; gap: 25px; flex-wrap: wrap; margin-top: 10px; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: #fff; border-radius: 20px; padding: 40px; width: 90%; max-width: 450px; text-align: center; }

        @media print { button, .botoes-centro, .modal { display: none !important; } section { display: flex !important; } }
    </style>
</head>
<body onload="carregarCSV()">

    <audio id="somSucesso" src="audio/sucesso.mp3" preload="auto"></audio>

    <section id="entrada" style="display:flex;">
        <div class="logo-container"><img src="unimed_vitoria_logo.png"></div>
        <h1>Vota√ß√£o CIPA-PAUV</h1>
        <h2>Gest√£o 2026/2027</h2>
        <div class="botoes-centro">
            <button class="primary" onclick="abrirLogin()">Entrar para Votar</button>
            <button class="primary" onclick="acessoAdmin()">Resultado Parcial</button>
        </div>
    </section>

    <section id="login">
        <div class="logo-container"><img src="unimed_vitoria_logo.png"></div>
        <h1>Identifica√ß√£o</h1>
        <h2>Digite sua matr√≠cula para acessar</h2>
        <input type="text" id="matricula" placeholder="Ex: 1234" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <div class="botoes-centro">
            <button class="primary" onclick="proximoLogin()">Avan√ßar</button>
            <button class="secondary" onclick="voltarEntrada()">Sair</button>
        </div>
    </section>

    <section id="confirmaLogin">
        <div class="logo-container"><img src="unimed_vitoria_logo.png"></div>
        <h1>Confirme seus Dados</h1>
        <div style="background:white; padding:40px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.1); margin-bottom:40px; width:100%; max-width:500px; border: 2px solid #006837;">
            <p id="mostraNomeMatricula" style="font-size:26px; color:#006837; line-height:1.4; font-weight: bold;"></p>
        </div>
        <div class="botoes-centro">
            <button class="primary" onclick="entrarVotacao()">Confirmar e Votar</button>
            <button class="secondary" onclick="voltarLogin()">Corrigir Matr√≠cula</button>
        </div>
    </section>

    <section id="votacao">
        <div class="logo-container"><img src="unimed_vitoria_logo.png"></div>
        <h1>Painel de Vota√ß√£o</h1>
        <h2>Escolha um candidato e clique em confirmar</h2>
        <div id="painel"></div>
        <div class="botoes-centro">
            <button class="primary" onclick="abrirConfirmacao()">Confirmar Voto</button>
            <button class="secondary" onclick="cancelarVotacao()">Cancelar</button>
        </div>
    </section>

    <section id="admin">
        <div class="logo-container"><img src="unimed_vitoria_logo.png"></div>
        <h1>Resultado Parcial</h1>
        <div class="grafico" id="resultado"></div>
        <div style="font-size:24px; font-weight:bold; color:#006837; margin-top:20px;" id="infoEleitores">
            Eleitores que votaram: 0
        </div>
        <div class="botoes-centro" style="margin-top:40px;">
            <button class="info" onclick="exportarExcel()">üìä Exportar Planilha</button>
            <button class="primary" onclick="window.print()">üñ®Ô∏è Imprimir</button>
            <button class="secondary" onclick="abrirSenhaLimpar()">üóëÔ∏è Limpar Votos</button>
            <button class="primary" onclick="voltar()">In√≠cio</button>
        </div>
    </section>

    <div class="modal" id="modalConfirmar">
        <div class="modal-box">
            <img id="modalFoto" src="" style="width:150px; height:150px; border-radius:50%; border:4px solid #006837; margin-bottom:20px; object-fit:cover;">
            <h3 id="modalNome" style="font-size:24px; color:#006837; margin-bottom:15px;"></h3>
            <p style="font-size:18px; margin-bottom:30px;">Confirma seu voto para este candidato?</p>
            <div class="botoes-centro">
                <button class="primary" onclick="confirmarVoto()">SIM</button>
                <button class="secondary" onclick="fecharModais()">N√ÉO</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalSenha">
        <div class="modal-box">
            <h2>Acesso Restrito</h2><br>
            <input type="password" id="senhaAdmin" style="width:100%"><br>
            <div class="botoes-centro">
                <button class="primary" onclick="validarSenha()">Entrar</button>
                <button class="secondary" onclick="fecharModais()">Sair</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalLimpar">
        <div class="modal-box">
            <h2 style="color:red">Aten√ß√£o!</h2><br>
            <p>Digite a senha para apagar todos os votos:</p><br>
            <input type="password" id="senhaLimpar" style="width:100%"><br>
            <div class="botoes-centro">
                <button class="secondary" onclick="confirmarLimparVotos()">ZERAR</button>
                <button class="primary" onclick="fecharModais()">CANCELAR</button>
            </div>
        </div>
    </div>

    <script>
        // Objeto que ser√° preenchido pelo arquivo CSV
        let colaboradores = {};

        // Fun√ß√£o para carregar o CSV
        async function carregarCSV() {
            try {
                const resposta = await fetch('listacolaboradores.csv');
                if (!resposta.ok) throw new Error("Arquivo CSV n√£o encontrado.");
                
                const texto = await resposta.text();
                const linhas = texto.split('\n');

                linhas.forEach(linha => {
                    // Trata CSV separado por ponto e v√≠rgula ou v√≠rgula
                    const colunas = linha.split(';');
                    if (colunas.length >= 2) {
                        const matricula = colunas[0].trim();
                        const nome = colunas[1].trim();
                        if (matricula !== "" && matricula.toLowerCase() !== "matricula") {
                            colaboradores[matricula] = nome;
                        }
                    }
                });
                console.log("Colaboradores carregados com sucesso!");
            } catch (erro) {
                console.error("Erro ao carregar lista:", erro);
                alert("Erro ao carregar lista de colaboradores. Verifique o arquivo CSV.");
            }
        }

        const fotos = [
            "fotos/01-Wanilton_Laurenco.jpg", "fotos/02-maria_oliveira.jpg",
            "fotos/03-ana_pereira.jpg", "fotos/04-carlos_souza.jpg",
            "fotos/05-lucas_ferreira.jpg", "fotos/06-ana_paula.jpg",
            "fotos/07-bruna_martins.jpg", "fotos/08-ricardo_lima.jpg",
            "fotos/09-juliana_rodrigues.jpg"
        ];

        const nomesCandidatos = fotos.map(f => {
            const arquivo = f.split('/').pop().split('.')[0];
            return arquivo.slice(0, 2) + " - " + arquivo.slice(3).replace(/_/g, ' ');
        });

        let votos = JSON.parse(localStorage.getItem("votosCIPA")) || Array(fotos.length).fill(0);
        let votantes = JSON.parse(localStorage.getItem("votantesCIPA")) || [];
        let matriculaAtual = "";
        let votoTemp = null;

        const painel = document.getElementById("painel");
        fotos.forEach((foto, i) => {
            const div = document.createElement("div");
            div.className = "candidato";
            div.innerHTML = `<img src="${foto}"><div style="font-weight:bold; color:#006837;">${nomesCandidatos[i]}</div>`;
            div.onclick = () => {
                document.querySelectorAll(".candidato").forEach(c => c.classList.remove("selecionado"));
                div.classList.add("selecionado");
                votoTemp = i;
            };
            painel.appendChild(div);
        });

        function mostrarSection(id) {
            document.querySelectorAll("section").forEach(s => s.style.display = "none");
            document.getElementById(id).style.display = "flex";
        }

        function abrirLogin() { mostrarSection("login"); }
        function voltarEntrada() { location.reload(); }

        function proximoLogin() {
            const mat = document.getElementById("matricula").value.trim();
            if (!colaboradores[mat]) { alert("Matr√≠cula n√£o cadastrada ou arquivo CSV n√£o carregado."); return; }
            if (votantes.includes(mat)) { alert("Esta matr√≠cula j√° votou."); return; }
            matriculaAtual = mat;
            document.getElementById("mostraNomeMatricula").innerHTML = `NOME: ${colaboradores[mat]}<br>MATR√çCULA: ${mat}`;
            mostrarSection("confirmaLogin");
        }

        function entrarVotacao() { mostrarSection("votacao"); }
        function voltarLogin() { mostrarSection("login"); }

        function abrirConfirmacao() {
            if (votoTemp === null) { alert("Selecione um candidato."); return; }
            document.getElementById("modalFoto").src = fotos[votoTemp];
            document.getElementById("modalNome").textContent = nomesCandidatos[votoTemp];
            document.getElementById("modalConfirmar").style.display = "flex";
        }

        function confirmarVoto() {
            const som = document.getElementById("somSucesso");
            if (som) { som.currentTime = 0; som.play().catch(e => console.log(e)); }
            votos[votoTemp]++;
            votantes.push(matriculaAtual);
            localStorage.setItem("votosCIPA", JSON.stringify(votos));
            localStorage.setItem("votantesCIPA", JSON.stringify(votantes));
            fecharModais();
            alert("VOTO REGISTRADO COM SUCESSO!");
            location.reload();
        }

        function acessoAdmin() { document.getElementById("modalSenha").style.display = "flex"; }
        function validarSenha() {
            if (document.getElementById("senhaAdmin").value === "admin123") {
                fecharModais(); mostrarSection("admin"); mostrarResultado();
            } else { alert("Senha incorreta"); }
        }

        function mostrarResultado() {
            const container = document.getElementById("resultado");
            container.innerHTML = "";
            const totalMax = Math.max(...votos, 1);
            votos.map((v, i) => ({ nome: nomesCandidatos[i], qtd: v }))
                 .sort((a, b) => b.qtd - a.qtd)
                 .forEach(item => {
                    const div = document.createElement("div");
                    div.style.marginBottom = "20px";
                    div.innerHTML = `<div style="font-weight:bold; margin-bottom:5px;">${item.nome}</div><div class="barra-fundo"><div class="barra-preenchimento" style="width:${(item.qtd/totalMax*100)}%">${item.qtd} voto(s)</div></div>`;
                    container.appendChild(div);
                 });
            document.getElementById("infoEleitores").textContent = `Eleitores que votaram: ${votantes.length}`;
        }

        function exportarExcel() {
            let conteudo = "\ufeffMatr√≠cula;Nome\n";
            votantes.forEach(mat => { conteudo += `${mat};${colaboradores[mat] || 'N/A'}\n`; });
            const blob = new Blob([conteudo], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "relatorio_votantes.csv";
            link.click();
        }

        function abrirSenhaLimpar() { document.getElementById("modalLimpar").style.display = "flex"; }
        function confirmarLimparVotos() {
            if (document.getElementById("senhaLimpar").value === "admin1234") {
                localStorage.clear(); location.reload();
            } else { alert("Senha incorreta"); }
        }

        function fecharModais() { document.querySelectorAll(".modal").forEach(m => m.style.display = "none"); }
        function voltar() { location.reload(); }
        function cancelarVotacao() { location.reload(); }
    </script>
</body>
</html>